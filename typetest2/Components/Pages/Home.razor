@page "/"
@rendermode InteractiveServer

<big>Try typing the sentence below as fast as you can!</big>
<p>
@for (int i = 0; i < CorrectSentence.Length; i++)
{
    char c = CorrectSentence[i];
    string style = i < UserInput.Length
        ? (UserInput[i] == c ? "color:green;" : "color:red;")
        : "color:gray;";
    <span style="@style">@c</span>
}
</p>

<MudProgressLinear Value="@ProgressPercent" Color="Color.Primary" Style="margin-bottom:10px;" />

<MudInput @bind-Value="UserInput"
          @onkeydown="OnKeyDown"
          Variant="Variant.Outlined"
          Disabled="@IsCompleted"
          Placeholder="Start typing here..."
          aria-label="Typing input" />

@if (IsCompleted)
{
    @if (ElapsedTime.HasValue)
    {
        <p>Time taken: @ElapsedTime.Value.TotalSeconds.ToString("F2") seconds</p>
        <p>Words Per Minute: @((GetWordCount() / (ElapsedTime.Value.TotalSeconds / 60)).ToString("F1"))</p>
    }
    else
    {
        <p>Calculating time...</p>
    }
    <p>Mistakes: @mistakes</p>
    <MudButton OnClick="ResetTest" Variant="Variant.Filled" Color="Color.Secondary">Try Again</MudButton>
}
else
{
    <p>@ResultMessage</p>
    <MudButton OnClick="ResetTest" Variant="Variant.Outlined" Color="Color.Secondary">Restart</MudButton>
}

@code {
    private const string CorrectSentence = "the quick brown fox jumps over the lazy dog";
    private string UserInput = string.Empty;
    private string ResultMessage => UserInput == CorrectSentence ? "✅ Matched!" : "❌ Keep Typing...";

    private DateTime? StartTime;
    private TimeSpan? ElapsedTime;

    private int mistakes = 0;
    private bool IsCompleted => UserInput == CorrectSentence;

    private double ProgressPercent =>
        100.0 * Math.Min(UserInput.Length, CorrectSentence.Length) / CorrectSentence.Length;

    private int GetWordCount()
    {
        return CorrectSentence.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        // Only count mistakes for character keys and if not completed
        if (!IsCompleted && !string.IsNullOrEmpty(UserInput) && UserInput.Length <= CorrectSentence.Length)
        {
            // Only count if the key is a single character (ignores Shift, Ctrl, etc.)
            if (!string.IsNullOrEmpty(e.Key) && e.Key.Length == 1)
            {
                int idx = UserInput.Length - 1;
                if (idx >= 0 && UserInput[idx] != CorrectSentence[idx])
                {
                    mistakes++;
                }
            }
        }
    }

    private void ResetTest()
    {
        UserInput = string.Empty;
        StartTime = null;
        ElapsedTime = null;
        mistakes = 0;
    }
    
    private async Task OnInputChanged(string newInput)
    {
        // Start timer when user starts typing (first non-empty input)
        if (StartTime == null && !string.IsNullOrEmpty(newInput))
        {
            StartTime = DateTime.Now;
            ElapsedTime = null;
            mistakes = 0;
        }

        // Only allow up to the length of the correct sentence
        if (newInput.Length > CorrectSentence.Length)
            newInput = newInput.Substring(0, CorrectSentence.Length);

        UserInput = newInput;

        // Stop timer and update output immediately when user finishes typing correctly
        if (UserInput == CorrectSentence && StartTime != null && !ElapsedTime.HasValue)
        {
            ElapsedTime = DateTime.Now - StartTime.Value;
            await InvokeAsync(StateHasChanged);
        }
    }

}